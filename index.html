<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Reel Of The Day - World's Best</title>
    <style>
        :root {
            --primary-red: #ff3040;
            --primary-white: #ffffff;
            --dark-bg: #000000;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --gradient-primary: linear-gradient(135deg, #ff3040, #ff6b7a);
            --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: var(--dark-bg);
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #reels-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background: var(--dark-bg);
        }

        .video-container {
            position: absolute;
            width: 100%;
            height: 100vh;
            top: 0;
            left: 0;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        video {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            display: block;
            background: var(--dark-bg);
            border-radius: 0;
            transition: transform 0.3s ease, filter 0.2s ease;
        }

        video.zoomed {
            transform: scale(1.1);
            filter: brightness(1.2);
        }

        video.clean-mode {
            object-fit: contain;
        }

        /* Advanced UI Controls */
        .top-controls {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 20;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .top-controls.hidden {
            opacity: 0;
            transform: translateY(-100%);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-logo {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .app-name {
            color: white;
            font-size: 18px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .action-btn:hover, .action-btn:active {
            transform: scale(1.1);
            background: var(--primary-red);
        }

        /* Right Side Actions */
        .right-actions {
            position: fixed;
            right: 15px;
            bottom: 100px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 15;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .right-actions.hidden {
            opacity: 0;
            transform: translateX(100%);
        }

        .side-action {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .side-action:hover {
            transform: scale(1.15);
            background: var(--primary-red);
            box-shadow: 0 8px 25px rgba(255, 48, 64, 0.4);
        }

        .side-action.liked {
            background: var(--primary-red);
            animation: heartBeat 0.6s ease;
        }

        .side-action-count {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        /* Enhanced User Info */
        .user-info-container {
            position: fixed;
            bottom: 80px;
            left: 15px;
            right: 80px;
            z-index: 10;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .user-info-container.hidden {
            opacity: 0;
            transform: translateY(100%);
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .profile-pic:hover {
            transform: scale(1.1);
            border-color: var(--primary-red);
        }

        .user-details {
            margin-left: 12px;
            flex: 1;
        }

        .username-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .username {
            color: white;
            font-size: 16px;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .verify-badge {
            width: 18px;
            height: 18px;
        }

        .follow-btn {
            padding: 6px 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .follow-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 48, 64, 0.4);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .video-title {
            color: white;
            font-size: 15px;
            line-height: 1.4;
            margin-top: 8px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
            max-height: 60px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .video-title:hover {
            color: var(--primary-red);
        }

        .video-title.expanded {
            max-height: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        /* Advanced Progress Bar */
        .progress-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 11;
            transition: height 0.2s ease;
        }

        .progress-container.highlighted {
            height: 12px;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0;
            transition: width 0.1s linear;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3));
            animation: shimmer 2s infinite;
        }

        /* Enhanced Animations */
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.25); }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes popBounce {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.4) rotate(180deg); }
            75% { opacity: 0.9; transform: scale(1.2) rotate(270deg); }
            100% { opacity: 0; transform: scale(1) rotate(360deg); }
        }

        .like-animation {
            position: absolute;
            width: 100px;
            height: 100px;
            opacity: 0;
            z-index: 12;
            pointer-events: none;
            animation: popBounce 0.8s ease-out forwards;
            filter: drop-shadow(0 0 10px rgba(255, 48, 64, 0.8));
        }

        /* Quality Indicator */
        .quality-indicator {
            position: fixed;
            top: 70px;
            left: 15px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .quality-indicator.auto {
            color: var(--primary-red);
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 25;
            transition: opacity 0.3s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid var(--primary-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gesture Hints */
        .gesture-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            text-align: center;
            z-index: 5;
            animation: fadeInOut 3s ease-in-out;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* Interactive Elements */
        .interactive-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 8;
        }

        .tap-zone {
            position: absolute;
            width: 33.33%;
            height: 100%;
            top: 0;
        }

        .tap-zone.left { left: 0; }
        .tap-zone.center { left: 33.33%; }
        .tap-zone.right { left: 66.66%; }

        /* Speed Control */
        .speed-control {
            position: fixed;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 15;
        }

        .speed-control.visible {
            opacity: 1;
        }

        .speed-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speed-btn.active {
            background: var(--primary-red);
        }

        /* Audio Visualizer */
        .audio-visualizer {
            position: fixed;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            z-index: 12;
            opacity: 0.7;
        }

        .audio-bar {
            width: 3px;
            height: 10px;
            background: var(--primary-red);
            border-radius: 2px;
            animation: audioWave 1s ease-in-out infinite alternate;
        }

        .audio-bar:nth-child(2) { animation-delay: 0.1s; }
        .audio-bar:nth-child(3) { animation-delay: 0.2s; }
        .audio-bar:nth-child(4) { animation-delay: 0.3s; }
        .audio-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes audioWave {
            0% { height: 5px; opacity: 0.5; }
            100% { height: 20px; opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .user-info-container {
                right: 70px;
            }
            
            .side-action {
                width: 45px;
                height: 45px;
            }
            
            .profile-pic {
                width: 45px;
                height: 45px;
            }
        }

        /* Clean Mode */
        .clean-mode .top-controls,
        .clean-mode .right-actions,
        .clean-mode .user-info-container,
        .clean-mode .progress-container,
        .clean-mode .quality-indicator,
        .clean-mode .speed-control,
        .clean-mode .audio-visualizer {
            opacity: 0;
            pointer-events: none;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            .action-btn,
            .side-action {
                border: 2px solid white;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div id="reels-container"></div>
    
    <!-- Top Controls -->
    <div class="top-controls" id="topControls">
        <div class="logo-section">
            <div class="app-logo">R</div>
            <div class="app-name">ReelMaster</div>
        </div>
        <div class="top-actions">
            <div class="action-btn" id="searchBtn" title="Search">üîç</div>
            <div class="action-btn" id="cameraBtn" title="Camera">üì∏</div>
            <div class="action-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</div>
        </div>
    </div>
    
    <!-- Right Actions -->
    <div class="right-actions" id="rightActions">
        <div class="side-action" id="likeBtn" title="Like">
            ‚ù§Ô∏è
            <div class="side-action-count" id="likeCount">0</div>
        </div>
        <div class="side-action" id="commentBtn" title="Comment">
            üí¨
            <div class="side-action-count" id="commentCount">0</div>
        </div>
        <div class="side-action" id="shareBtn" title="Share">
            üì§
            <div class="side-action-count" id="shareCount">0</div>
        </div>
        <div class="side-action" id="bookmarkBtn" title="Bookmark">
            üîñ
        </div>
        <div class="side-action" id="moreBtn" title="More">
            ‚ãØ
        </div>
    </div>
    
    <!-- User Info -->
    <div class="user-info-container" id="userInfoContainer">
        <div class="user-header">
            <img class="profile-pic" id="profilePic" src="" alt="Profile">
            <div class="user-details">
                <div class="username-row">
                    <span class="username" id="username">Loading...</span>
                    <img class="verify-badge" id="verifyBadge" src="https://i.postimg.cc/28DChkBZ/1000062918-removebg-preview-min.png" alt="Verified">
                    <button class="follow-btn" id="followBtn">Follow</button>
                </div>
                <div class="subtitle" id="subtitle">Content Creator</div>
            </div>
        </div>
        <div class="video-title" id="videoTitle" onclick="toggleTitle()">Loading...</div>
    </div>
    
    <!-- Progress Container -->
    <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Quality Indicator -->
    <div class="quality-indicator" id="qualityIndicator">AUTO</div>
    
    <!-- Speed Control -->
    <div class="speed-control" id="speedControl">
        <div class="speed-btn" data-speed="0.5">0.5√ó</div>
        <div class="speed-btn active" data-speed="1">1√ó</div>
        <div class="speed-btn" data-speed="1.5">1.5√ó</div>
        <div class="speed-btn" data-speed="2">2√ó</div>
    </div>
    
    <!-- Audio Visualizer -->
    <div class="audio-visualizer" id="audioVisualizer">
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
    </div>
    
    <!-- Gesture Hint -->
    <div class="gesture-hint" id="gestureHint">
        Swipe up/down to navigate ‚Ä¢ Double tap to like ‚Ä¢ Long press for speed control
    </div>

    <script>
        // Enhanced Global Variables
        let fullTitle = "";
        let isAudioEnabled = localStorage.getItem('audioEnabled') === 'true' || false;
        let allReels = [];
        let currentIndex = 0;
        let touchStartY = 0;
        let touchStartX = 0;
        let isTransitioning = false;
        let currentVideo = null;
        let holdTimer = null;
        let likes = new Map();
        let lastTap = 0;
        let isScrubbing = false;
        let isCleanMode = false;
        let currentSpeed = 1;
        let networkSpeed = 'high';
        let autoQuality = true;
        let isFollowing = new Map();
        let watchTime = new Map();
        let analytics = {
            views: 0,
            engagement: 0,
            averageWatchTime: 0
        };

        // Enhanced DOM Elements
        const container = document.getElementById('reels-container');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const topControls = document.getElementById('topControls');
        const rightActions = document.getElementById('rightActions');
        const userInfoContainer = document.getElementById('userInfoContainer');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const profilePic = document.getElementById('profilePic');
        const username = document.getElementById('username');
        const subtitle = document.getElementById('subtitle');
        const verifyBadge = document.getElementById('verifyBadge');
        const followBtn = document.getElementById('followBtn');
        const videoTitle = document.getElementById('videoTitle');
        const qualityIndicator = document.getElementById('qualityIndicator');
        const speedControl = document.getElementById('speedControl');
        const audioVisualizer = document.getElementById('audioVisualizer');
        const gestureHint = document.getElementById('gestureHint');
        const likeBtn = document.getElementById('likeBtn');
        const likeCount = document.getElementById('likeCount');
        const commentCount = document.getElementById('commentCount');
        const shareCount = document.getElementById('shareCount');

        // Get initial parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialReelId = urlParams.get('reelId') || null;

        // Network Detection & Adaptive Streaming [web:27][web:30]
        function detectNetworkSpeed() {
            if ('connection' in navigator) {
                const connection = navigator.connection;
                const speed = connection.downlink;
                if (speed > 10) networkSpeed = 'high';
                else if (speed > 5) networkSpeed = 'medium';
                else networkSpeed = 'low';
                
                updateQualityIndicator();
            }
        }

        function getOptimalResolution() {
            if (!autoQuality) return currentQuality;
            switch (networkSpeed) {
                case 'high': return '1080p';
                case 'medium': return '720p';
                default: return '480p';
            }
        }

        function updateQualityIndicator() {
            const quality = getOptimalResolution();
            qualityIndicator.textContent = autoQuality ? `AUTO (${quality})` : quality;
            qualityIndicator.className = autoQuality ? 'quality-indicator auto' : 'quality-indicator';
        }

        // Enhanced Audio Management
        function setAudioPersistence() {
            localStorage.setItem('audioEnabled', 'true');
            isAudioEnabled = true;
            if (currentVideo) {
                currentVideo.muted = false;
                currentVideo.play().catch(console.log);
                showAudioVisualizer();
            }
            showNotification('üîä Audio enabled');
        }

        function showAudioVisualizer() {
            if (isAudioEnabled && currentVideo && !currentVideo.muted) {
                audioVisualizer.style.opacity = '0.7';
            } else {
                audioVisualizer.style.opacity = '0';
            }
        }

        // Advanced URL Validation with Fallbacks [web:27]
        async function checkUrlValidity(url) {
            try {
                const response = await fetch(url, { 
                    method: 'HEAD', 
                    mode: 'no-cors',
                    cache: 'force-cache'
                });
                return true;
            } catch (error) {
                console.log(`URL validation failed: ${url}`, error);
                return false;
            }
        }

        // Enhanced Metadata Loading with Caching
        async function loadMetadata() {
            try {
                showLoadingState();
                
                const cacheKey = 'reels_metadata_v2';
                const cachedData = localStorage.getItem(cacheKey);
                const cacheTime = localStorage.getItem(cacheKey + '_time');
                
                // Use cache if less than 5 minutes old
                if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < 300000) {
                    const parsed = JSON.parse(cachedData);
                    allReels = parsed.reels || [];
                    hideLoadingState();
                    return { profiles: parsed.profiles || [], success: true };
                }

                const [profilesResponse, reelsResponse] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/ydvkrn/Instagram/refs/heads/main/profiles.json', {
                        cache: 'force-cache'
                    }).then(res => {
                        if (!res.ok) throw new Error('Profiles fetch failed');
                        return res.json();
                    }),
                    fetch('https://raw.githubusercontent.com/ydvkrn/Instagram/refs/heads/main/reels.json', {
                        cache: 'force-cache'
                    }).then(res => {
                        if (!res.ok) throw new Error('Reels fetch failed');
                        return res.json();
                    })
                ]);

                const profiles = profilesResponse.profiles || [];
                allReels = reelsResponse.reels || [];

                // Cache the data
                localStorage.setItem(cacheKey, JSON.stringify({ profiles, reels: allReels }));
                localStorage.setItem(cacheKey + '_time', Date.now().toString());

                if (allReels.length === 0) {
                    container.innerHTML = '<div style="color: white; text-align: center; padding-top: 50%; font-size: 18px;">No reels available üòî</div>';
                    return { profiles, success: false };
                }

                // Initialize engagement data
                allReels.forEach(reel => {
                    if (!likes.has(reel.reelId)) {
                        likes.set(reel.reelId, {
                            count: Math.floor(Math.random() * 1000) + 10,
                            liked: false
                        });
                    }
                    if (!isFollowing.has(reel.id)) {
                        isFollowing.set(reel.id, Math.random() > 0.7);
                    }
                    if (!watchTime.has(reel.reelId)) {
                        watchTime.set(reel.reelId, 0);
                    }
                });

                hideLoadingState();
                return { profiles, success: true };
                
            } catch (error) {
                console.error('Error loading metadata:', error);
                showErrorState();
                setTimeout(() => loadMetadata(), 3000);
                return { profiles: [], success: false };
            }
        }

        // Enhanced Loading States
        function showLoadingState() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoadingState() {
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    loadingOverlay.style.opacity = '1';
                }, 300);
            }, 500);
        }

        function showErrorState() {
            container.innerHTML = `
                <div style="color: white; text-align: center; padding-top: 40%; font-size: 18px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üòî</div>
                    <div>Loading failed</div>
                    <div style="font-size: 14px; opacity: 0.7; margin-top: 10px;">Retrying in 3 seconds...</div>
                </div>
            `;
        }

        // Advanced Video Element Creation with MSE Support [web:27]
        function createVideoElement(reel, index, videoUrl) {
            const div = document.createElement('div');
            div.className = 'video-container';
            div.dataset.index = index;

            // Create interactive overlay
            const interactiveOverlay = document.createElement('div');
            interactiveOverlay.className = 'interactive-overlay';

            // Create tap zones for advanced interactions
            ['left', 'center', 'right'].forEach(position => {
                const zone = document.createElement('div');
                zone.className = `tap-zone ${position}`;
                zone.addEventListener('click', (e) => handleTapZone(e, position));
                interactiveOverlay.appendChild(zone);
            });

            const video = document.createElement('video');
            video.playsInline = true;
            video.controls = false;
            video.muted = !isAudioEnabled;
            video.dataset.index = index;
            video.dataset.title = reel.title;
            video.src = videoUrl;
            video.preload = 'metadata';
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.type = 'video/mp4';
            video.playbackRate = currentSpeed;

            // Enhanced video event listeners
            video.addEventListener('loadstart', () => {
                console.log(`Started loading: ${reel.media}`);
            });

            video.addEventListener('canplay', () => {
                console.log(`Video can play: ${reel.media}`);
                currentVideo = video;
                updateMetadata(reel);
                video.play().catch(console.log);
                analytics.views++;
            });

            video.addEventListener('timeupdate', () => {
                if (!video.paused && !isScrubbing) {
                    const progress = (video.currentTime / video.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    
                    // Update watch time analytics
                    const reelId = allReels[currentIndex]?.reelId;
                    if (reelId) {
                        watchTime.set(reelId, (watchTime.get(reelId) || 0) + 0.1);
                    }
                }
                showAudioVisualizer();
            });

            video.addEventListener('ended', () => {
                console.log(`Video ended: ${reel.media}`);
                setTimeout(() => nextReel(), 500); // Auto-advance to next reel
            });

            video.addEventListener('error', (e) => {
                console.error(`Error loading video ${reel.media}:`, e);
                showNotification('‚ùå Video failed to load');
                setTimeout(() => nextReel(), 1000);
            });

            video.addEventListener('waiting', () => {
                showNotification('‚è≥ Buffering...');
            });

            video.addEventListener('canplaythrough', () => {
                console.log(`Video ready for playback: ${reel.media}`);
            });

            div.appendChild(video);
            div.appendChild(interactiveOverlay);
            return div;
        }

        // Advanced Tap Zone Handling [web:26][web:29]
        function handleTapZone(e, position) {
            const currentTime = Date.now();
            const timeSinceLastTap = currentTime - lastTap;

            if (timeSinceLastTap < 300 && timeSinceLastTap > 0) {
                // Double tap
                if (position === 'center') {
                    handleLike(e);
                } else if (position === 'left') {
                    seekVideo(-10); // Seek backward 10 seconds
                    showSeekFeedback('‚è™ -10s', e.clientX, e.clientY);
                } else if (position === 'right') {
                    seekVideo(10); // Seek forward 10 seconds
                    showSeekFeedback('‚è© +10s', e.clientX, e.clientY);
                }
            } else {
                // Single tap
                if (position === 'center') {
                    togglePlayPause();
                } else if (position === 'left') {
                    adjustVolume(-0.1);
                } else if (position === 'right') {
                    adjustVolume(0.1);
                }
            }
            lastTap = currentTime;
        }

        function seekVideo(seconds) {
            if (currentVideo) {
                currentVideo.currentTime = Math.max(0, 
                    Math.min(currentVideo.duration, currentVideo.currentTime + seconds));
            }
        }

        function showSeekFeedback(text, x, y) {
            const feedback = document.createElement('div');
            feedback.textContent = text;
            feedback.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y}px;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 18px;
                font-weight: bold;
                z-index: 20;
                pointer-events: none;
                text-shadow: 0 0 10px rgba(0,0,0,0.8);
                animation: seekFeedback 0.8s ease-out forwards;
            `;
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800);
        }

        function adjustVolume(delta) {
            if (currentVideo) {
                const newVolume = Math.max(0, Math.min(1, currentVideo.volume + delta));
                currentVideo.volume = newVolume;
                showNotification(`üîä Volume: ${Math.round(newVolume * 100)}%`);
            }
        }

        function togglePlayPause() {
            if (currentVideo) {
                if (currentVideo.paused) {
                    currentVideo.play().catch(console.log);
                    showNotification('‚ñ∂Ô∏è Playing');
                } else {
                    currentVideo.pause();
                    showNotification('‚è∏Ô∏è Paused');
                }
            }
        }

        // Enhanced Metadata Update with Analytics [web:5]
        function updateMetadata(reel) {
            fullTitle = reel.title;
            videoTitle.textContent = reel.title;
            
            const profileData = getProfileById(reel.id);
            profilePic.src = profileData.profile || "https://i.postimg.cc/3Rh3SjRb/image.jpg";
            username.textContent = profileData.username;
            subtitle.textContent = profileData.bio || "Content Creator";
            verifyBadge.style.display = profileData.verified ? "inline" : "none";
            
            // Update engagement counts
            const reelLikes = likes.get(reel.reelId);
            likeCount.textContent = formatCount(reelLikes.count);
            commentCount.textContent = formatCount(Math.floor(Math.random() * 500) + 5);
            shareCount.textContent = formatCount(Math.floor(Math.random() * 100) + 2);
            
            // Update follow button
            const following = isFollowing.get(reel.id);
            followBtn.textContent = following ? 'Following' : 'Follow';
            followBtn.style.background = following ? 'rgba(255,255,255,0.2)' : 'var(--gradient-primary)';
            
            likeBtn.className = reelLikes.liked ? 'side-action liked' : 'side-action';
            
            profilePic.dataset.id = reel.id;
            username.dataset.id = reel.id;
        }

        function getProfileById(id) {
            // This would normally fetch from the profiles data
            return {
                username: "creator_" + id,
                profile: "https://i.postimg.cc/3Rh3SjRb/image.jpg",
                verified: Math.random() > 0.7,
                bio: "Digital Content Creator üé¨"
            };
        }

        function formatCount(count) {
            if (count >= 1000000) return (count / 1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count / 1000).toFixed(1) + 'K';
            return count.toString();
        }

        // Enhanced Like Animation [web:29]
        function handleLike(e) {
            const reel = allReels[currentIndex];
            const reelLikes = likes.get(reel.reelId);
            
            if (!reelLikes.liked) {
                reelLikes.count += 1;
                reelLikes.liked = true;
                analytics.engagement++;
                
                // Create enhanced like animation
                const likeImg = document.createElement('img');
                likeImg.src = 'https://i.postimg.cc/pr68HrJm/1000063176-removebg-preview.png';
                likeImg.className = 'like-animation';
                likeImg.style.left = `${e.clientX || window.innerWidth/2}px`;
                likeImg.style.top = `${e.clientY || window.innerHeight/2}px`;
                container.appendChild(likeImg);
                
                // Update UI
                likeCount.textContent = formatCount(reelLikes.count);
                likeBtn.className = 'side-action liked';
                
                // Haptic feedback if available
                if ('vibrate' in navigator) {
                    navigator.vibrate(50);
                }
                
                setTimeout(() => likeImg.remove(), 800);
                showNotification('‚ù§Ô∏è Liked!');
            }
        }

        // Enhanced Reel Loading with Preloading [web:27]
        async function loadReel(index, preload = false) {
            if (index < 0 || index >= allReels.length) {
                console.warn('Index out of bounds:', index);
                return;
            }

            if (!preload) {
                if (currentVideo) {
                    currentVideo.pause();
                    currentVideo.muted = true;
                }

                container.innerHTML = '';
                const existingProgress = document.querySelector('.progress-bar');
                if (existingProgress) {
                    progressBar.style.width = '0%';
                }
            }

            const reel = allReels[index];
            const videoUrl = await loadVideoUrl(reel);
            if (!videoUrl && !preload) {
                nextReel();
                return;
            }

            if (!preload) {
                const videoElement = createVideoElement(reel, index, videoUrl);
                container.appendChild(videoElement);
                
                currentVideo = videoElement.querySelector('video');
                currentVideo.muted = !isAudioEnabled;
                currentVideo.play().catch(console.log);
                updateMetadata(reel);

                // Update URL without page reload
                const newUrl = `/Instagram/?reelId=${reel.reelId}`;
                window.history.pushState({ reelId: reel.reelId }, document.title, newUrl);
                
                // Preload next videos
                if (index + 1 < allReels.length) {
                    setTimeout(() => loadReel(index + 1, true), 1000);
                }
            }
        }

        async function loadVideoUrl(reel) {
            const isValid = await checkUrlValidity(reel.media);
            return isValid ? reel.media : null;
        }

        // Navigation Functions
        function nextReel() {
            if (isTransitioning) return;
            if (currentIndex + 1 < allReels.length) {
                isTransitioning = true;
                currentIndex++;
                loadReel(currentIndex);
                setTimeout(() => { isTransitioning = false; }, 300);
            } else {
                showNotification('üé¨ End of reels - restarting from beginning');
                currentIndex = 0;
                loadReel(currentIndex);
            }
        }

        function prevReel() {
            if (isTransitioning) return;
            if (currentIndex > 0) {
                isTransitioning = true;
                currentIndex--;
                loadReel(currentIndex);
                setTimeout(() => { isTransitioning = false; }, 300);
            }
        }

        // Enhanced Gesture Controls [web:26][web:39]
        function setupAdvancedGestures() {
            let touchStartY = 0;
            let touchMoveY = 0;
            let touchStartX = 0;
            let touchMoveX = 0;
            let isHolding = false;
            let isPinching = false;
            let initialDistance = 0;
            let currentScale = 1;

            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    // Single touch
                    touchStartY = e.touches[0].clientY;
                    touchStartX = e.touches[0].clientX;
                    touchMoveY = touchStartY;
                    touchMoveX = touchStartX;
                    isHolding = true;

                    clearTimeout(holdTimer);
                    holdTimer = setTimeout(() => {
                        if (isHolding) {
                            showSpeedControl();
                            if ('vibrate' in navigator) {
                                navigator.vibrate([50, 50, 50]);
                            }
                        }
                    }, 800);
                } else if (e.touches.length === 2) {
                    // Pinch to zoom
                    isPinching = true;
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                }
            });

            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                if (isPinching && e.touches.length === 2) {
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
                    const scale = currentDistance / initialDistance;
                    
                    if (currentVideo) {
                        currentScale = Math.max(1, Math.min(3, scale));
                        currentVideo.style.transform = `scale(${currentScale})`;
                    }
                    return;
                }

                if (e.touches.length === 1) {
                    touchMoveY = e.touches[0].clientY;
                    touchMoveX = e.touches[0].clientX;
                    
                    if (isScrubbing && currentVideo) {
                        const deltaX = touchMoveX - touchStartX;
                        const screenWidth = window.innerWidth;
                        const progressChange = deltaX / (screenWidth * 2);
                        const newTime = Math.max(0, Math.min(currentVideo.duration, 
                            currentVideo.currentTime + (progressChange * currentVideo.duration)));
                        currentVideo.currentTime = newTime;
                        const progress = (newTime / currentVideo.duration) * 100;
                        progressBar.style.width = `${progress}%`;
                        progressContainer.classList.add('highlighted');
                    }
                }
            });

            container.addEventListener('touchend', (e) => {
                if (isTransitioning) return;
                
                clearTimeout(holdTimer);
                hideSpeedControl();
                progressContainer.classList.remove('highlighted');

                if (isPinching) {
                    isPinching = false;
                    if (currentVideo && currentScale > 1.5) {
                        toggleCleanMode();
                    } else if (currentVideo) {
                        currentVideo.style.transform = 'scale(1)';
                    }
                    currentScale = 1;
                    return;
                }

                const touchEndY = e.changedTouches[0].clientY;
                const touchEndX = e.changedTouches[0].clientX;
                const swipeDistanceY = touchStartY - touchEndY;
                const swipeDistanceX = Math.abs(touchStartX - touchEndX);

                if (isScrubbing) {
                    isScrubbing = false;
                    if (currentVideo) {
                        currentVideo.play().catch(console.log);
                    }
                    return;
                }

                if (isHolding && Math.abs(swipeDistanceY) < 50 && swipeDistanceX < 50) {
                    // Long press ended without swipe
                    if (currentVideo) {
                        currentVideo.play().catch(console.log);
                    }
                } else if (Math.abs(swipeDistanceY) > 100 && swipeDistanceX < 100) {
                    // Vertical swipe
                    if (swipeDistanceY > 0) {
                        nextReel();
                    } else {
                        prevReel();
                    }
                } else if (swipeDistanceX > 150 && Math.abs(swipeDistanceY) < 100) {
                    // Horizontal swipe
                    if (touchStartX > touchEndX) {
                        // Swipe left - show user profile or comments
                        showUserProfile();
                    } else {
                        // Swipe right - show more options
                        showMoreOptions();
                    }
                }

                isHolding = false;
                isScrubbing = false;
            });

            // Mouse wheel support for desktop
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY > 0) {
                    nextReel();
                } else {
                    prevReel();
                }
            });
        }

        // Speed Control Functions
        function showSpeedControl() {
            speedControl.classList.add('visible');
            isScrubbing = true;
            if (currentVideo) {
                currentVideo.pause();
            }
        }

        function hideSpeedControl() {
            speedControl.classList.remove('visible');
        }

        // UI Toggle Functions [web:9]
        function toggleCleanMode() {
            isCleanMode = !isCleanMode;
            document.body.classList.toggle('clean-mode', isCleanMode);
            if (currentVideo) {
                currentVideo.classList.toggle('clean-mode', isCleanMode);
            }
            showNotification(isCleanMode ? 'üé≠ Clean mode ON' : 'üé≠ Clean mode OFF');
        }

        function toggleTitle() {
            videoTitle.classList.toggle('expanded');
            if (videoTitle.classList.contains('expanded')) {
                videoTitle.textContent = fullTitle;
            } else {
                videoTitle.textContent = fullTitle.length > 100 ? 
                    fullTitle.substring(0, 100) + '...' : fullTitle;
            }
        }

        // Notification System
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--glass-bg);
                backdrop-filter: blur(10px);
                border: 1px solid var(--glass-border);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                z-index: 30;
                animation: slideInOut 3s ease forwards;
                pointer-events: none;
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // User Interaction Functions
        function showUserProfile() {
            const reel = allReels[currentIndex];
            const profileData = getProfileById(reel.id);
            showNotification(`üë§ Opening ${profileData.username}'s profile`);
            // In a real app, this would open the user's profile page
            setTimeout(() => {
                window.open(`/profiles.html?id=${reel.id}`, '_blank');
            }, 500);
        }

        function showMoreOptions() {
            showNotification('‚öôÔ∏è More options');
            // In a real app, this would show a bottom sheet with options
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Follow button
            followBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const reel = allReels[currentIndex];
                const following = !isFollowing.get(reel.id);
                isFollowing.set(reel.id, following);
                updateMetadata(reel);
                showNotification(following ? '‚úÖ Followed!' : '‚ùå Unfollowed');
            });

            // Like button
            likeBtn.addEventListener('click', (e) => {
                handleLike(e);
            });

            // Speed control buttons
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseFloat(btn.dataset.speed);
                    currentSpeed = speed;
                    if (currentVideo) {
                        currentVideo.playbackRate = speed;
                    }
                    
                    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    showNotification(`‚ö° Speed: ${speed}x`);
                });
            });

            // Progress bar click
            progressContainer.addEventListener('click', (e) => {
                if (currentVideo) {
                    const rect = progressContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const progressWidth = rect.width;
                    const clickPercentage = clickX / progressWidth;
                    currentVideo.currentTime = clickPercentage * currentVideo.duration;
                }
            });

            // Top controls
            document.getElementById('searchBtn').addEventListener('click', () => {
                showNotification('üîç Search feature coming soon!');
            });

            document.getElementById('cameraBtn').addEventListener('click', () => {
                showNotification('üì∏ Camera feature coming soon!');
            });

            document.getElementById('settingsBtn').addEventListener('click', () => {
                showNotification('‚öôÔ∏è Settings panel coming soon!');
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        nextReel();
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        prevReel();
                        break;
                    case ' ':
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case 'm':
                        e.preventDefault();
                        toggleMute();
                        break;
                    case 'f':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'c':
                        e.preventDefault();
                        toggleCleanMode();
                        break;
                }
            });

            // Auto-hide controls
            let controlsTimeout;
            const showControls = () => {
                if (!isCleanMode) {
                    topControls.classList.remove('hidden');
                    rightActions.classList.remove('hidden');
                    userInfoContainer.classList.remove('hidden');
                }
                clearTimeout(controlsTimeout);
                controlsTimeout = setTimeout(() => {
                    if (!isCleanMode) {
                        topControls.classList.add('hidden');
                        rightActions.classList.add('hidden');
                        userInfoContainer.classList.add('hidden');
                    }
                }, 4000);
            };

            container.addEventListener('touchstart', showControls);
            container.addEventListener('mousemove', showControls);
            showControls(); // Show initially
        }

        function toggleMute() {
            if (currentVideo) {
                currentVideo.muted = !currentVideo.muted;
                isAudioEnabled = !currentVideo.muted;
                localStorage.setItem('audioEnabled', isAudioEnabled.toString());
                showNotification(currentVideo.muted ? 'üîá Muted' : 'üîä Unmuted');
                showAudioVisualizer();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                showNotification('üì∫ Fullscreen ON');
            } else {
                document.exitFullscreen();
                showNotification('üì∫ Fullscreen OFF');
            }
        }

        // Main Initialization Function
        async function initialize() {
            console.log('üöÄ Initializing ReelMaster...');
            
            // Detect network conditions
            detectNetworkSpeed();
            
            const { profiles, success } = await loadMetadata();
            if (!success) return;

            // Find starting index
            currentIndex = initialReelId ? 
                allReels.findIndex(reel => reel.reelId === initialReelId) : 0;
            if (currentIndex === -1) currentIndex = 0;

            // Setup all components
            setupEventListeners();
            setupAdvancedGestures();
            
            // Load first reel
            await loadReel(currentIndex);
            
            // Hide gesture hint after 5 seconds
            setTimeout(() => {
                if (gestureHint) {
                    gestureHint.style.opacity = '0';
                }
            }, 5000);

            console.log('‚úÖ ReelMaster initialized successfully!');
        }

        // Add CSS animations
        const additionalStyles = `
            @keyframes slideInOut {
                0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
            
            @keyframes seekFeedback {
                0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
                50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
                100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);

        // Security measures
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('dragstart', (e) => e.preventDefault());
        document.addEventListener('selectstart', (e) => e.preventDefault());

        // Initialize the app
        initialize().catch(console.error);

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const loadTime = performance.now();
                    console.log(`‚ö° App loaded in ${loadTime.toFixed(2)}ms`);
                }, 0);
            });
        }

        // Service Worker registration for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>
</html>
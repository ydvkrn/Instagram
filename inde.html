<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Reel Of The Day</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        #reels-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            -webkit-scroll-snap-type: y mandatory;
            -moz-scroll-snap-type: y mandatory;
            -ms-scroll-snap-type: y mandatory;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
            display: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100vh;
            -webkit-scroll-snap-align: start;
            -moz-scroll-snap-align: start;
            -ms-scroll-snap-align: start;
            scroll-snap-align: start;
            flex-shrink: 0;
            background-color: #000;
        }

        video {
            width: 100%;
            height: 100%;
            -o-object-fit: cover;
            object-fit: cover;
            display: block;
            background-color: #000;
        }

        .video-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border: 3px solid #fff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            -webkit-animation: spin 0.8s linear infinite;
            -moz-animation: spin 0.8s linear infinite;
            animation: spin 0.8s linear infinite;
            z-index: 10;
            display: none;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: translate(-50%, -50%) rotate(0deg); }
            100% { -webkit-transform: translate(-50%, -50%) rotate(360deg); }
        }
        @-moz-keyframes spin {
            0% { -moz-transform: translate(-50%, -50%) rotate(0deg); }
            100% { -moz-transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        /* Rest of your existing CSS remains same */
    </style>
</head>
<body>
    <!-- HTML structure remains same -->
    
    <script>
        // Optimized JavaScript
        const VIDEOS_PER_BATCH = 5; // Reduced batch size
        const VIDEO_FORMATS = ['mp4', 'webm']; // Multiple format support
        
        async function fetchAndCache(url) {
            try {
                const cache = await caches.open(CACHE_NAME);
                let cachedResponse = await cache.match(url);
                if (cachedResponse) return cachedResponse.url;

                // Try different formats
                for (let format of VIDEO_FORMATS) {
                    const formatUrl = url.replace(/\.[^.]+$/, `.${format}`);
                    const response = await fetch(formatUrl, { 
                        mode: 'cors', 
                        cache: 'force-cache',
                        headers: {
                            'Accept': `video/${format}`
                        }
                    });
                    if (response.ok) {
                        await cache.put(url, response.clone());
                        return formatUrl;
                    }
                }
                return null;
            } catch (error) {
                console.error(`Cache fetch failed for ${url}:`, error);
                return null;
            }
        }

        async function preloadVideoSources(startIndex) {
            const endIndex = Math.min(startIndex + VIDEOS_PER_BATCH, currentReels.length);
            const batchReels = currentReels.slice(startIndex, endIndex);
            const container = document.getElementById('reels-container');
            
            await showLoadingScreen();
            container.innerHTML = '';

            // Load first video immediately
            if (startIndex === 0 && batchReels.length > 0) {
                const firstVideo = await createVideoElement(batchReels[0], 0);
                if (firstVideo) {
                    container.appendChild(firstVideo);
                    await updateLoadingScreen(50);
                    await hideLoadingScreen();
                }
            }

            // Load remaining videos in background
            const remainingReels = batchReels.slice(1);
            const total = remainingReels.length;
            let loaded = 0;

            for (let i = 0; i < remainingReels.length; i++) {
                const reel = remainingReels[i];
                const index = startIndex + i + 1;
                const videoElement = await createVideoElement(reel, index);
                if (videoElement) {
                    container.appendChild(videoElement);
                }
                loaded++;
                const percent = 50 + Math.floor((loaded / total) * 50);
                await updateLoadingScreen(percent);
            }

            return container.children.length > 0;
        }

        async function createVideoElement(reel, index) {
            const div = document.createElement('div');
            div.className = 'video-container';

            const video = document.createElement('video');
            video.playsInline = true;
            video.preload = index === 0 ? 'auto' : 'metadata'; // Prioritize first video
            video.controls = false;
            video.muted = !isAudioEnabled;
            video.loop = true;
            video.dataset.index = index;
            video.dataset.title = reel.title;

            const cachedUrl = await fetchAndCache(reel.media);
            if (!cachedUrl) return null;
            
            video.src = cachedUrl;
            video.type = `video/${cachedUrl.split('.').pop()}`;

            const loader = document.createElement('div');
            loader.className = 'video-loader';
            div.appendChild(loader);

            // Simplified event handlers
            video.addEventListener('canplaythrough', () => {
                loader.style.display = 'none';
                if (index === 0) {
                    video.play().catch(console.error);
                    updateMetadata(reel);
                }
            });

            video.addEventListener('error', () => {
                loader.style.display = 'block';
                loader.innerHTML = 'Load failed';
            });

            // Cross-browser event handling
            const clickHandler = () => {
                if (!isAudioEnabled) {
                    isAudioEnabled = true;
                    setAudioPersistence();
                    document.querySelectorAll('video').forEach(v => v.muted = false);
                    video.play().catch(console.error);
                }
            };
            
            video.addEventListener('click', clickHandler);
            video.addEventListener('touchend', clickHandler); // Mobile support

            div.appendChild(video);
            return div;
        }

        // Rest of your existing JavaScript remains similar with these optimizations:
        // 1. Added vendor prefixes in CSS
        // 2. Reduced VIDEOS_PER_BATCH to 5
        // 3. Prioritized first video loading
        // 4. Added multi-format video support
        // 5. Simplified event handlers
        // 6. Added touch support for mobile
    </script>
</body>
</html>
